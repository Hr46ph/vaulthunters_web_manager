{% extends "base.html" %}

{% block title %}Console - VaultHunters Web Manager{% endblock %}

{% block extra_css %}
<style>
    .console-output {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        height: 400px;
        overflow-y: auto;
        padding: 15px;
        border: 1px solid var(--bs-border-color);
        border-radius: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
    }
    
    /* Dark theme specific console styling */
    [data-bs-theme="dark"] .console-output {
        background-color: #1e1e1e;
        color: #ffffff;
        border-color: #444;
    }
    
    /* Light theme specific console styling */
    [data-bs-theme="light"] .console-output {
        background-color: #f8f9fa;
        color: #212529;
        border-color: #dee2e6;
    }
    
    .console-input {
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }
    
    [data-bs-theme="dark"] .console-input {
        background-color: #2d2d2d;
        color: #ffffff;
        border: 1px solid #555;
    }
    
    [data-bs-theme="dark"] .console-input:focus {
        background-color: #2d2d2d;
        color: #ffffff;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .command-history {
        max-height: 150px;
        overflow-y: auto;
    }
    
    .command-suggestion {
        cursor: pointer;
        padding: 5px 10px;
        border-bottom: 1px solid var(--bs-border-color);
    }
    
    .command-suggestion:hover {
        background-color: var(--bs-secondary-bg);
    }
    
    .console-timestamp {
        color: var(--bs-secondary-color);
        font-size: 12px;
    }
    
    .console-command {
        color: #00ff00;
    }
    
    .console-response {
        color: var(--bs-body-color);
        margin-left: 10px;
    }
    
    /* Dark theme response color */
    [data-bs-theme="dark"] .console-response {
        color: #ffffff;
    }
    
    .console-error {
        color: #ff6b6b;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-terminal"></i> Server Console</h2>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="clearConsole()">
                    <i class="fas fa-eraser"></i> Clear
                </button>
                <button type="button" class="btn btn-outline-info" onclick="toggleAutoScroll()" id="autoScrollBtn">
                    <i class="fas fa-arrow-down"></i> Auto-scroll: ON
                </button>
            </div>
        </div>

        <!-- Console Output -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Console Output</h5>
            </div>
            <div class="card-body p-0">
                <div id="console-output" class="console-output"></div>
            </div>
        </div>

        <!-- Command Input -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Command Input</h5>
            </div>
            <div class="card-body">
                <form id="console-form" class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text">/</span>
                        <input type="text" 
                               class="form-control console-input" 
                               id="command-input" 
                               placeholder="Enter server command (e.g., list, say Hello, tp player)" 
                               autocomplete="off">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </form>
                
                <!-- Quick Commands -->
                <div class="mb-3">
                    <small class="text-muted">Server Commands:</small>
                    <div class="btn-group flex-wrap mb-2" role="group">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmRconCommand('stop', 'stop the server')">
                            <i class="fas fa-stop"></i> Stop Server
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('save-all')">
                            <i class="fas fa-save"></i> Save World
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('list')">
                            <i class="fas fa-users"></i> List Players
                        </button>
                    </div>
                    
                    <small class="text-muted">Game Commands:</small>
                    <div class="btn-group flex-wrap" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('tps')">TPS</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('help')">Help</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('whitelist list')">Whitelist</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('weather clear')">Clear Weather</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('time set day')">Set Day</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Connection Status</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="connectRcon()">
                            <i class="fas fa-plug"></i> Connect
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="disconnectRcon()">
                            <i class="fas fa-unlink"></i> Disconnect
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>RCON Status:</strong>
                        <span id="rcon-status" class="badge bg-secondary">Checking...</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Last Command:</strong>
                        <span id="last-command" class="text-muted">None</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
let autoScroll = true;
let commandHistory = [];
let historyIndex = -1;

// Initialize console
document.addEventListener('DOMContentLoaded', function() {
    checkRconStatus();
    setupCommandHistory();
    
    // Focus command input
    document.getElementById('command-input').focus();
});

// Handle form submission
document.getElementById('console-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('command-input');
    const command = input.value.trim();
    
    if (command) {
        executeCommand(command);
        input.value = '';
        
        // Add to history
        if (commandHistory[commandHistory.length - 1] !== command) {
            commandHistory.push(command);
            if (commandHistory.length > 50) {
                commandHistory.shift();
            }
        }
        historyIndex = commandHistory.length;
    }
});

// Setup command history navigation
function setupCommandHistory() {
    const input = document.getElementById('command-input');
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (historyIndex > 0) {
                historyIndex--;
                input.value = commandHistory[historyIndex];
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (historyIndex < commandHistory.length - 1) {
                historyIndex++;
                input.value = commandHistory[historyIndex];
            } else {
                historyIndex = commandHistory.length;
                input.value = '';
            }
        }
    });
}



// Clear console
function clearConsole() {
    document.getElementById('console-output').innerHTML = '';
}

// Toggle auto-scroll
function toggleAutoScroll() {
    autoScroll = !autoScroll;
    const btn = document.getElementById('autoScrollBtn');
    const icon = btn.querySelector('i');
    
    if (autoScroll) {
        btn.innerHTML = '<i class="fas fa-arrow-down"></i> Auto-scroll: ON';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-info');
    } else {
        btn.innerHTML = '<i class="fas fa-pause"></i> Auto-scroll: OFF';
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-outline-secondary');
    }
}

// RCON status tracking
let lastRconStatus = null;
let reconnectAttempts = 0;
let maxReconnectAttempts = 5;

// Check RCON status with auto-reconnection
function checkRconStatus() {
    fetch('/console/status')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('rcon-status');
            const currentStatus = data.connected;
            
            if (data.connected) {
                statusElement.className = 'badge bg-success';
                statusElement.textContent = 'Connected';
                statusElement.title = `Connected to ${data.host}:${data.port}`;
                
                // Reset reconnect attempts on successful connection
                reconnectAttempts = 0;
                
                // If we just reconnected, show success message
                if (lastRconStatus === false) {
                    appendToConsole(`<span class="console-response">✓ RCON automatically reconnected</span>`);
                }
            } else {
                statusElement.className = 'badge bg-danger';
                statusElement.textContent = 'Disconnected';
                statusElement.title = data.error || 'Connection failed';
                
                // Try to auto-reconnect if server might be available
                if (lastRconStatus === true || lastRconStatus === null) {
                    // First time disconnection or we were previously connected
                    appendToConsole(`<span class="console-error">RCON Connection Lost: ${escapeHtml(data.error || 'Unknown error')}</span>`);
                    appendToConsole(`<span class="console-response">⏳ Will attempt automatic reconnection...</span>`);
                }
                
                // Attempt auto-reconnection if we haven't exceeded max attempts
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(attemptAutoReconnect, 5000); // Try reconnecting after 5 seconds
                    reconnectAttempts++;
                }
            }
            
            // Update server status to check if server is running
            if (typeof updateServerStatus === 'function') {
                updateServerStatus();
            }
            
            lastRconStatus = currentStatus;
        })
        .catch(error => {
            const statusElement = document.getElementById('rcon-status');
            statusElement.className = 'badge bg-warning';
            statusElement.textContent = 'Network Error';
            statusElement.title = error.message;
            
            console.error('RCON Status Check Error:', error);
            lastRconStatus = false;
        });
}

// Attempt automatic reconnection
function attemptAutoReconnect() {
    // First check if server is online by checking server status
    fetch('/server/status')
        .then(response => response.json())
        .then(serverData => {
            // Only try RCON reconnection if server is online
            if (serverData.online) {
                appendToConsole(`<span class="console-response">🔄 Server detected online, attempting RCON reconnection (attempt ${reconnectAttempts}/${maxReconnectAttempts})...</span>`);
                
                // Try to reconnect
                fetch('/console/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        appendToConsole(`<span class="console-response">✓ RCON automatically reconnected after server restart</span>`);
                        reconnectAttempts = 0; // Reset counter on success
                        checkRconStatus(); // Update status immediately
                    } else {
                        appendToConsole(`<span class="console-error">✗ Auto-reconnection failed: ${escapeHtml(data.error)}</span>`);
                    }
                })
                .catch(error => {
                    appendToConsole(`<span class="console-error">✗ Auto-reconnection request failed: ${escapeHtml(error.message)}</span>`);
                });
            } else {
                // Server still not online, don't spam reconnection attempts
                appendToConsole(`<span class="console-response">⏳ Server still starting up, will retry when online...</span>`);
            }
        })
        .catch(error => {
            // Server status check failed, assume server not ready
            console.log('Server status check failed during auto-reconnect, will retry later');
        });
}

// Helper functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCSRFToken() {
    return document.querySelector('meta[name=csrf-token]').getAttribute('content');
}

// Connect RCON
function connectRcon() {
    const statusElement = document.getElementById('rcon-status');
    statusElement.className = 'badge bg-warning';
    statusElement.textContent = 'Connecting...';
    
    fetch('/console/connect', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusElement.className = 'badge bg-success';
            statusElement.textContent = 'Connected';
            appendToConsole(`<span class="console-response">✓ RCON reconnected successfully</span>`);
            
            // Refresh status after connection
            setTimeout(checkRconStatus, 1000);
        } else {
            statusElement.className = 'badge bg-danger';
            statusElement.textContent = 'Connection Failed';
            appendToConsole(`<span class="console-error">✗ RCON connection failed: ${escapeHtml(data.error)}</span>`);
        }
    })
    .catch(error => {
        statusElement.className = 'badge bg-danger';
        statusElement.textContent = 'Network Error';
        appendToConsole(`<span class="console-error">✗ Connection request failed: ${escapeHtml(error.message)}</span>`);
    });
}

// Disconnect RCON
function disconnectRcon() {
    const statusElement = document.getElementById('rcon-status');
    statusElement.className = 'badge bg-warning';
    statusElement.textContent = 'Disconnecting...';
    
    fetch('/console/disconnect', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusElement.className = 'badge bg-secondary';
            statusElement.textContent = 'Disconnected';
            appendToConsole(`<span class="console-response">✓ RCON disconnected</span>`);
        } else {
            appendToConsole(`<span class="console-error">✗ Disconnect failed: ${escapeHtml(data.error)}</span>`);
        }
    })
    .catch(error => {
        appendToConsole(`<span class="console-error">✗ Disconnect request failed: ${escapeHtml(error.message)}</span>`);
    });
}

// Enhanced execute command with better error handling
function executeCommand(command) {
    const output = document.getElementById('console-output');
    const timestamp = new Date().toLocaleTimeString();
    
    // Add command to output
    appendToConsole(`<span class="console-timestamp">[${timestamp}]</span> <span class="console-command">/${command}</span>`);
    
    // Update last command
    document.getElementById('last-command').textContent = command;
    
    // Send command to server
    fetch('/console/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({command: command})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.response) {
                appendToConsole(`<span class="console-response">${escapeHtml(data.response)}</span>`);
            } else {
                appendToConsole(`<span class="console-response">Command executed successfully</span>`);
            }
            // Update status after successful command
            setTimeout(checkRconStatus, 500);
        } else {
            appendToConsole(`<span class="console-error">Error: ${escapeHtml(data.error || 'Unknown error')}</span>`);
            
            // If connection-related error, suggest reconnection
            if (data.error && (data.error.includes('connection') || data.error.includes('connect'))) {
                appendToConsole(`<span class="console-response">💡 Try using the Connect button to reestablish connection</span>`);
            }
        }
    })
    .catch(error => {
        appendToConsole(`<span class="console-error">Connection error: ${escapeHtml(error.message)}</span>`);
        appendToConsole(`<span class="console-response">💡 Try using the Connect button to reestablish connection</span>`);
    });
}

// Confirm dangerous RCON commands
function confirmRconCommand(command, description) {
    if (confirm(`Are you sure you want to ${description}?\n\nThis will execute: /${command}`)) {
        executeCommand(command);
    }
}

// Check RCON status periodically  
setInterval(checkRconStatus, 30000);
</script>
{% endblock %}