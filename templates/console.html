{% extends "base.html" %}

{% block title %}Console - VaultHunter Web Manager{% endblock %}

{% block extra_css %}
<style>
    .console-output {
        background-color: #1e1e1e;
        color: #ffffff;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        height: 400px;
        overflow-y: auto;
        padding: 15px;
        border: 1px solid #444;
        border-radius: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .console-input {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        background-color: #2d2d2d;
        color: #ffffff;
        border: 1px solid #555;
    }
    
    .console-input:focus {
        background-color: #2d2d2d;
        color: #ffffff;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .command-history {
        max-height: 150px;
        overflow-y: auto;
    }
    
    .command-suggestion {
        cursor: pointer;
        padding: 5px 10px;
        border-bottom: 1px solid #eee;
    }
    
    .command-suggestion:hover {
        background-color: #f8f9fa;
    }
    
    .console-timestamp {
        color: #888;
        font-size: 12px;
    }
    
    .console-command {
        color: #00ff00;
    }
    
    .console-response {
        color: #ffffff;
        margin-left: 10px;
    }
    
    .console-error {
        color: #ff6b6b;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-terminal"></i> Server Console</h2>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="clearConsole()">
                    <i class="fas fa-eraser"></i> Clear
                </button>
                <button type="button" class="btn btn-outline-info" onclick="toggleAutoScroll()" id="autoScrollBtn">
                    <i class="fas fa-arrow-down"></i> Auto-scroll: ON
                </button>
            </div>
        </div>

        <!-- Console Output -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Console Output</h5>
            </div>
            <div class="card-body p-0">
                <div id="console-output" class="console-output"></div>
            </div>
        </div>

        <!-- Command Input -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Command Input</h5>
            </div>
            <div class="card-body">
                <form id="console-form" class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text">/</span>
                        <input type="text" 
                               class="form-control console-input" 
                               id="command-input" 
                               placeholder="Enter server command (e.g., list, say Hello, tp player)" 
                               autocomplete="off">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </form>
                
                <!-- Quick Commands -->
                <div class="mb-3">
                    <small class="text-muted">Quick Commands:</small>
                    <div class="btn-group flex-wrap" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('list')">List Players</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('tps')">TPS</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('help')">Help</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('whitelist list')">Whitelist</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('weather clear')">Clear Weather</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="executeCommand('time set day')">Set Day</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>RCON Status:</strong>
                        <span id="rcon-status" class="badge bg-secondary">Checking...</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Last Command:</strong>
                        <span id="last-command" class="text-muted">None</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- RCON Password Modal -->
<div class="modal fade" id="rconPasswordModal" tabindex="-1" aria-labelledby="rconPasswordModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rconPasswordModalLabel">RCON Authentication</h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i> Enter the RCON password to connect to the Minecraft server console.
                </div>
                <form id="rcon-password-form">
                    <div class="mb-3">
                        <label for="rcon-password" class="form-label">RCON Password</label>
                        <input type="password" 
                               class="form-control" 
                               id="rcon-password" 
                               placeholder="Enter RCON password" 
                               required>
                        <div class="form-text">This password is stored securely in your session and not saved permanently.</div>
                    </div>
                    <div id="rcon-error-message" class="alert alert-danger d-none" role="alert"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="authenticateRcon()">
                    <i class="fas fa-key"></i> Connect
                </button>
                <button type="button" class="btn btn-secondary" onclick="disconnectRcon()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let autoScroll = true;
let commandHistory = [];
let historyIndex = -1;
let rconAuthenticated = false;
let rconPasswordModal = null;

// Initialize console
document.addEventListener('DOMContentLoaded', function() {
    rconPasswordModal = new bootstrap.Modal(document.getElementById('rconPasswordModal'));
    checkRconStatus();
    setupCommandHistory();
    
    // Focus command input
    document.getElementById('command-input').focus();
    
    // Handle Enter key in password modal
    document.getElementById('rcon-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            authenticateRcon();
        }
    });
});

// Handle form submission
document.getElementById('console-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('command-input');
    const command = input.value.trim();
    
    if (command) {
        executeCommand(command);
        input.value = '';
        
        // Add to history
        if (commandHistory[commandHistory.length - 1] !== command) {
            commandHistory.push(command);
            if (commandHistory.length > 50) {
                commandHistory.shift();
            }
        }
        historyIndex = commandHistory.length;
    }
});

// Setup command history navigation
function setupCommandHistory() {
    const input = document.getElementById('command-input');
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (historyIndex > 0) {
                historyIndex--;
                input.value = commandHistory[historyIndex];
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (historyIndex < commandHistory.length - 1) {
                historyIndex++;
                input.value = commandHistory[historyIndex];
            } else {
                historyIndex = commandHistory.length;
                input.value = '';
            }
        }
    });
}

// Execute command
function executeCommand(command) {
    // Check if authenticated first
    if (!rconAuthenticated) {
        showPasswordModal();
        // Store command to execute after authentication
        window.pendingCommand = command;
        return;
    }
    
    const output = document.getElementById('console-output');
    const timestamp = new Date().toLocaleTimeString();
    
    // Add command to output
    appendToConsole(`<span class="console-timestamp">[${timestamp}]</span> <span class="console-command">/${command}</span>`);
    
    // Update last command
    document.getElementById('last-command').textContent = command;
    
    // Send command to server
    fetch('/console/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({command: command})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.response) {
                appendToConsole(`<span class="console-response">${escapeHtml(data.response)}</span>`);
            } else {
                appendToConsole(`<span class="console-response">Command executed successfully</span>`);
            }
        } else {
            // If authentication failed, show modal again
            if (data.error && data.error.includes('authentication')) {
                rconAuthenticated = false;
                showPasswordModal();
                window.pendingCommand = command;
            } else {
                appendToConsole(`<span class="console-error">Error: ${escapeHtml(data.error || 'Unknown error')}</span>`);
            }
        }
    })
    .catch(error => {
        appendToConsole(`<span class="console-error">Connection error: ${escapeHtml(error.message)}</span>`);
    });
}

// Append text to console
function appendToConsole(text) {
    const output = document.getElementById('console-output');
    output.innerHTML += text + '\n';
    
    if (autoScroll) {
        output.scrollTop = output.scrollHeight;
    }
}

// Clear console
function clearConsole() {
    document.getElementById('console-output').innerHTML = '';
}

// Toggle auto-scroll
function toggleAutoScroll() {
    autoScroll = !autoScroll;
    const btn = document.getElementById('autoScrollBtn');
    const icon = btn.querySelector('i');
    
    if (autoScroll) {
        btn.innerHTML = '<i class="fas fa-arrow-down"></i> Auto-scroll: ON';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-info');
    } else {
        btn.innerHTML = '<i class="fas fa-pause"></i> Auto-scroll: OFF';
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-outline-secondary');
    }
}

// Check RCON status
function checkRconStatus() {
    fetch('/console/status')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('rcon-status');
            if (data.connected) {
                statusElement.className = 'badge bg-success';
                statusElement.textContent = 'Connected';
                rconAuthenticated = true;
            } else {
                statusElement.className = 'badge bg-danger';
                statusElement.textContent = 'Disconnected';
                rconAuthenticated = false;
            }
        })
        .catch(error => {
            const statusElement = document.getElementById('rcon-status');
            statusElement.className = 'badge bg-warning';
            statusElement.textContent = 'Error';
            rconAuthenticated = false;
        });
}

// Show password modal
function showPasswordModal() {
    document.getElementById('rcon-password').value = '';
    document.getElementById('rcon-error-message').classList.add('d-none');
    rconPasswordModal.show();
    setTimeout(() => {
        document.getElementById('rcon-password').focus();
    }, 500);
}

// Authenticate RCON
function authenticateRcon() {
    const password = document.getElementById('rcon-password').value;
    const errorDiv = document.getElementById('rcon-error-message');
    
    if (!password) {
        showError('Please enter a password');
        return;
    }
    
    // Test the password
    fetch('/console/authenticate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({password: password})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            rconAuthenticated = true;
            rconPasswordModal.hide();
            checkRconStatus();
            
            // Execute pending command if any
            if (window.pendingCommand) {
                executeCommand(window.pendingCommand);
                window.pendingCommand = null;
            }
            
            appendToConsole('<span class="console-response">RCON authentication successful</span>');
        } else {
            showError(data.error || 'Authentication failed');
        }
    })
    .catch(error => {
        showError('Connection error: ' + error.message);
    });
    
    function showError(message) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('d-none');
    }
}

// Disconnect RCON
function disconnectRcon() {
    fetch('/console/disconnect', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(() => {
        rconAuthenticated = false;
        rconPasswordModal.hide();
        checkRconStatus();
        appendToConsole('<span class="console-response">RCON disconnected</span>');
    })
    .catch(error => {
        rconPasswordModal.hide();
        appendToConsole(`<span class="console-error">Disconnect error: ${escapeHtml(error.message)}</span>`);
    });
}

// Helper functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCSRFToken() {
    return document.querySelector('meta[name=csrf-token]').getAttribute('content');
}

// Check RCON status periodically
setInterval(checkRconStatus, 10000);
</script>
{% endblock %}